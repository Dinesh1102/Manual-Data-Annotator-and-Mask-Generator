{% extends 'boilerplate.html' %}

{% block title %}Selective Segmentation{% endblock %}

{% block content %}
{%if flag==1%}


 <div class="mainDiv">
  <div class="wrapperDiv"> 
    <div class="heading">
      <h1>Selective Segmentation</h1>
    </div>
    <div class="heading"> 
      <h1>Upload a file</h1>
    </div>

    <div class="chooseFile">

      <form action="/crop_res" method="POST" enctype="multipart/form-data">
        <img src="{{url_for('display_image_crop',filename=filename)}}" alt="">
        <input type="hidden" id="cropped" name="input" value="{{filename}}" />
        <button type="submit" id="submit" class="cropButton">Submit</button>
      </form>

    </div>

  </div>

</div>  

{% elif flag==2 %}

<div class="mainDivOutput">
  <div class="wrapperOutput">
    <h1>Selective Segmentation</h1>
    <h1>Output</h1>
    <div>
       <img src="{{url_for('display_image_crop_res',filename=filename)}}" alt="">
    </div>
  </div>
</div>

{% else %}

<div class="mainDiv">
  <div class="wrapperDiv">
    <div class="heading">
      <h1>Selective Segmentation</h1>
    </div>
    <div class="heading">
      <h1>Upload a file</h1>
    </div>

    <div class="chooseFile">
      <form action="/cropimage" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="cropped" name="croppedImage" />
        <label for="fileInput" id="label">
          <h2>Drag files here or click to choose files.</h2>
        </label>
        <input type="file" id="fileInput" name="image" />
        <canvas id="canvas"></canvas>
        <button type="submit" id="cropButton" class="cropButton">Crop</button>
      </form>
    </div>
  </div>
</div>

{% endif %}
<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let image = new Image();
  let startX, startY, endX, endY, isDrawing = false;

  canvas.addEventListener("mousedown", (e) => {
    startX = e.clientX - canvas.offsetLeft;
    startY = e.clientY - canvas.offsetTop;
    isDrawing = true;
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!isDrawing) return;
    endX = e.clientX - canvas.offsetLeft;
    endY = e.clientY - canvas.offsetTop;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0);
    ctx.strokeRect(startX, startY, endX - startX, endY - startY);
  });
  canvas.addEventListener("mouseup", (e) => {
    endX = e.clientX - canvas.offsetLeft;
    endY = e.clientY - canvas.offsetTop;
    isDrawing = false;
  });

  document.getElementById("fileInput").addEventListener("change", (e) => {
    const reader = new FileReader();
    reader.onload = (event) => {
      image.src = event.target.result;
      image.onload = () => {
        canvas.width = image.width;
        canvas.height = image.height;
        canvas.style.display = "block";
       
        
        document.getElementById("cropButton").style.display = "block";
        document.getElementById("label").style.display = "none";
        ctx.drawImage(image, 0, 0);

      };
    };


    reader.readAsDataURL(e.target.files[0]);

  });

  document.getElementById("cropButton").addEventListener("click", async () => {
    const croppedCanvas = document.createElement("canvas");
    croppedCanvas.width = endX - startX;
    croppedCanvas.height = endY - startY;
    const croppedCtx = croppedCanvas.getContext("2d");
    croppedCtx.drawImage(
      image,
      startX,
      startY,
      endX - startX,
      endY - startY,
      0,
      0,
      endX - startX,
      endY - startY
    );

    const croppedImage = croppedCanvas.toDataURL("image/png");
    document.getElementById("cropped").value = croppedImage;
    await new Promise(resolve => setTimeout(resolve, 100));

    document.querySelector("form").submit();
  });

</script>
{% endblock %}