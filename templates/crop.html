<!DOCTYPE html>
<html>
  <head>
    <style>
      #canvas {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    {%if flag==1%}
      <form action="/crop_res" method="POST" enctype="multipart/form-data">
        <img src="{{url_for('display_image_crop',filename=filename)}}" alt="">
        <input type="hidden" id="cropped" name="input" value="{{filename}}" />
        <button type="submit" id="submit">Submit</button>
      </form>
    {% elif flag==2 %}
    <a href="{{url_for('display_image_crop_res',filename=filename)}}" download="">
      <img src="{{url_for('display_image_crop_res',filename=filename)}}" alt="">
      <button>Download</button>
    </a>
    {% else %}
      <form action="/cropimage" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="cropped" name="croppedImage" />
        <input type="file" id="fileInput" name="image"/>
        <br />
        <canvas id="canvas"></canvas>
        <br />
        <button type="submit" id="cropButton">Crop</button>
      </form>
    {% endif %}
    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      let image = new Image();
      let startX, startY, endX, endY, isDrawing = false;

      canvas.addEventListener("mousedown", (e) => {
        startX = e.clientX - canvas.offsetLeft;
        startY = e.clientY - canvas.offsetTop;
        isDrawing = true;
      });
      canvas.addEventListener("mousemove", (e) => {
        if (!isDrawing) return;
        endX = e.clientX - canvas.offsetLeft;
        endY = e.clientY - canvas.offsetTop;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
      });
      canvas.addEventListener("mouseup", (e) => {
        endX = e.clientX - canvas.offsetLeft;
        endY = e.clientY - canvas.offsetTop;
        isDrawing = false;
      });

      document.getElementById("fileInput").addEventListener("change", (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          image.src = event.target.result;
          image.onload = () => {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
          };
        };
        reader.readAsDataURL(e.target.files[0]);
      });

      document.getElementById("cropButton").addEventListener("click", async () => {
        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = endX - startX;
        croppedCanvas.height = endY - startY;
        const croppedCtx = croppedCanvas.getContext("2d");
        croppedCtx.drawImage(
          image,
          startX,
          startY,
          endX - startX,
          endY - startY,
          0,
          0,
          endX - startX,
          endY - startY
        );
        const croppedImage = croppedCanvas.toDataURL("image/png");
        document.getElementById("cropped").value = croppedImage;
        await new Promise(resolve => setTimeout(resolve, 100));
        document.querySelector("form").submit();
      });
      
    </script>
  </body>
</html>
